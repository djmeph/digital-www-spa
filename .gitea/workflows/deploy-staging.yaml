name: Build and Push Image
on: [ push ]

jobs:
  build:
    name: Build and push image
    runs-on: ubuntu-latest
    container: catthehacker/ubuntu:act-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Create Kubeconfig
      run: |
        mkdir $HOME/.kube
        echo "${{ secrets.KUBECONFIG_BUILDX }}" > $HOME/.kube/config        

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: kubernetes
        driver-opts: |
          namespace=act-runner
          qemu.install=true

    - name: Login to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: gitea.djmeph.net
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/digital-www/Dockerfile
        push: true
        platforms: linux/amd64,linux/arm64
        tags: |
          gitea.djmeph.net/lakes-of-fire/2024-digital-www
        cache-to: type=registry,ref=gitea.djmeph.net/lakes-of-fire/2024-digital-www:buildcache,mode=max
        cathe-from: type=registry,gitea.djmeph.net/lakes-of-fire/2024-digital-www

# jobs:
#   deploy:
    # env:
    #   GIT_TERMINAL_PROMPT: '0'
    # runs-on: ubuntu-latest
    # steps:
    #   - name: Checkout
    #     uses: actions/checkout@v4

    #   - name: Use Node.js 20
    #     uses: actions/setup-node@v4
    #     with:
    #       node-version: 20

    #   - name: Install dependencies
    #     shell: bash
    #     run: npm install -g yarn node-gyp

    #   - name: Prepare node_modules
    #     shell: bash
    #     run: yarn install
